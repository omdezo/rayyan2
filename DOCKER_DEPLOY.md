# Docker Deployment Guide üê≥

## Overview

This guide covers deploying the Rayan Design platform using Docker with:
- **MongoDB** (local service for auth & user data)
- **Cloudinary** (CDN for product images & digital downloads)
- **Next.js App** (containerized application)

---

## üìã Prerequisites

1. **Docker & Docker Compose** installed
   ```bash
   # Check installation
   docker --version
   docker-compose --version
   ```

2. **Cloudinary Account** (Free tier)
   - Sign up: https://cloudinary.com
   - Get: Cloud Name, API Key, API Secret

---

## üöÄ Quick Start

### Step 1: Configure Environment

Copy the example environment file:
```bash
cp .env.docker .env
```

Edit `.env` and add your Cloudinary credentials:
```env
# Cloudinary Configuration (REQUIRED)
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret
```

### Step 2: Build and Start Services

```bash
# Build and start all services
docker-compose up --build -d

# Check status
docker-compose ps
```

**Services will start on:**
- App: http://localhost:3000
- MongoDB: localhost:27017
- Mongo Express (DB UI): http://localhost:8081

### Step 3: Seed the Database

```bash
# Run seed script inside the container
docker-compose exec app npx tsx scripts/seed.ts
```

**This creates:**
- Admin: `admin@rayan.com` / `admin123`
- Test User: `user@test.com` / `user123`
- 5 sample products
- 5 sample orders
- Default settings

### Step 4: Access the Application

üéâ **Visit:** http://localhost:3000/ar/login

**Login with:**
- Email: `admin@rayan.com`
- Password: `admin123`

---

## üì¶ Docker Architecture

### Services

#### 1. MongoDB (Database)
```yaml
Purpose: Store users, authentication data
Port: 27017
Volume: mongodb_data (persistent)
Health Check: Enabled
```

**Why local MongoDB?**
- Fast auth queries
- No external dependencies
- Data privacy
- Cost-effective

#### 2. Next.js App (Application)
```yaml
Purpose: Web application
Port: 3000
Depends on: MongoDB
Environment: Production mode
```

#### 3. Mongo Express (Optional)
```yaml
Purpose: Database management UI
Port: 8081
Access: http://localhost:8081
Credentials: admin / admin123
```

---

## üóÇÔ∏è File Structure

```
rayan2/
‚îú‚îÄ‚îÄ Dockerfile                 # App container definition
‚îú‚îÄ‚îÄ docker-compose.yml         # Multi-container setup
‚îú‚îÄ‚îÄ .dockerignore             # Excluded files
‚îú‚îÄ‚îÄ .env                      # Environment variables
‚îî‚îÄ‚îÄ .env.docker              # Environment template
```

### Dockerfile Stages

1. **deps**: Install dependencies
2. **builder**: Build Next.js application
3. **runner**: Production runtime

**Optimization:**
- Multi-stage build (smaller image)
- Non-root user
- Standalone output
- Layer caching

---

## üîß Environment Variables

### Required

```env
# MongoDB (Auto-configured in Docker)
MONGODB_URI=mongodb://admin:admin123@mongodb:27017/rayan-store?authSource=admin

# NextAuth (Generated)
NEXTAUTH_SECRET=<auto-generated>
NEXTAUTH_URL=http://localhost:3000

# Cloudinary (YOU MUST PROVIDE)
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret
```

### Optional

```env
# MongoDB Admin
MONGO_ROOT_PASSWORD=admin123

# Mongo Express
MONGO_EXPRESS_USER=admin
MONGO_EXPRESS_PASSWORD=admin123
```

---

## üìö Docker Commands

### Start Services

```bash
# Start all services
docker-compose up -d

# Start specific service
docker-compose up -d app

# Start with build
docker-compose up --build -d
```

### Stop Services

```bash
# Stop all services
docker-compose down

# Stop and remove volumes (‚ö†Ô∏è deletes database)
docker-compose down -v
```

### View Logs

```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f app
docker-compose logs -f mongodb

# Last 100 lines
docker-compose logs --tail=100 app
```

### Execute Commands

```bash
# Run seed script
docker-compose exec app npx tsx scripts/seed.ts

# Access app shell
docker-compose exec app sh

# Access MongoDB shell
docker-compose exec mongodb mongosh -u admin -p admin123

# Run NPM commands
docker-compose exec app npm install <package>
```

### Database Operations

```bash
# Backup database
docker-compose exec mongodb mongodump -u admin -p admin123 --out=/data/backup

# Restore database
docker-compose exec mongodb mongorestore -u admin -p admin123 /data/backup

# View database size
docker-compose exec mongodb mongosh -u admin -p admin123 --eval "db.stats()"
```

---

## üéØ Production Deployment

### Production Configuration

1. **Update Environment**
   ```env
   # Use production domain
   NEXTAUTH_URL=https://yourdomain.com

   # Strong password
   MONGO_ROOT_PASSWORD=<strong-password>

   # Disable Mongo Express
   # Comment out mongo-express service in docker-compose.yml
   ```

2. **Use MongoDB Atlas** (Recommended)
   ```env
   # Replace local MongoDB with Atlas
   MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/rayan-store
   ```

3. **SSL/TLS**
   - Add Nginx/Caddy reverse proxy
   - Enable HTTPS
   - Configure SSL certificates

4. **Resource Limits**
   ```yaml
   services:
     app:
       deploy:
         resources:
           limits:
             cpus: '1.0'
             memory: 1G
   ```

---

## üîí Security Best Practices

### 1. Environment Variables
- Never commit `.env` to git
- Use strong passwords in production
- Rotate secrets regularly

### 2. MongoDB
- Change default credentials
- Enable authentication (already done)
- Use MongoDB Atlas for production
- Regular backups

### 3. Application
- Keep dependencies updated
- Use HTTPS in production
- Enable rate limiting
- Monitor logs

---

## üìä Monitoring

### Health Checks

```bash
# Check container health
docker-compose ps

# Test MongoDB connection
docker-compose exec mongodb mongosh -u admin -p admin123 --eval "db.adminCommand('ping')"

# Test app health
curl http://localhost:3000/api/products
```

### Resource Usage

```bash
# Container stats
docker stats

# Disk usage
docker system df

# Clean up
docker system prune -a
```

---

## üêõ Troubleshooting

### Issue: "Cannot connect to MongoDB"

**Solution 1:** Check if MongoDB is running
```bash
docker-compose ps mongodb
docker-compose logs mongodb
```

**Solution 2:** Restart MongoDB
```bash
docker-compose restart mongodb
```

**Solution 3:** Recreate containers
```bash
docker-compose down
docker-compose up --build -d
```

### Issue: "App crashes on startup"

**Check logs:**
```bash
docker-compose logs app
```

**Common causes:**
- Missing environment variables
- MongoDB not ready (wait for health check)
- Port 3000 already in use

**Fix:**
```bash
# Rebuild app
docker-compose up --build app

# Check environment
docker-compose exec app env | grep MONGODB_URI
```

### Issue: "Cloudinary upload fails"

**Verify credentials:**
```bash
docker-compose exec app env | grep CLOUDINARY
```

**Test Cloudinary:**
- Login to Cloudinary dashboard
- Check API usage
- Verify credentials are correct

### Issue: "Database data lost after restart"

**Cause:** Volume not persisted

**Solution:**
```bash
# Check volumes
docker volume ls

# Inspect volume
docker volume inspect rayan2_mongodb_data

# Never use docker-compose down -v in production
```

---

## üîÑ Updates & Maintenance

### Update Application

```bash
# Pull latest code
git pull

# Rebuild and restart
docker-compose up --build -d app

# Check logs
docker-compose logs -f app
```

### Update Dependencies

```bash
# Update package.json
# Then rebuild
docker-compose build --no-cache app
docker-compose up -d app
```

### Database Backup

```bash
# Create backup directory
mkdir -p backups

# Backup
docker-compose exec mongodb mongodump -u admin -p admin123 --out=/data/backup --db=rayan-store

# Copy to host
docker cp $(docker-compose ps -q mongodb):/data/backup ./backups/backup-$(date +%Y%m%d)

# Compress
tar -czf backups/backup-$(date +%Y%m%d).tar.gz backups/backup-$(date +%Y%m%d)
```

---

## üìà Scaling

### Horizontal Scaling

```yaml
services:
  app:
    deploy:
      replicas: 3
    # Add load balancer (Nginx/Traefik)
```

### Vertical Scaling

```yaml
services:
  app:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
```

### Database Scaling

- Use MongoDB Atlas (auto-scaling)
- Enable replica sets
- Add read replicas

---

## üåê CDN Strategy

### Cloudinary (Current Setup)

**Advantages:**
‚úÖ Free tier: 25GB storage, 25GB bandwidth
‚úÖ Automatic image optimization
‚úÖ CDN delivery worldwide
‚úÖ On-the-fly transformations
‚úÖ Secure URLs

**File Types:**
- Product images: `<img src="cloudinary-url" />`
- Digital downloads: Secure signed URLs
- Thumbnails: Auto-generated

**Upload Flow:**
1. Admin uploads via dashboard (`/api/upload`)
2. File sent to Cloudinary
3. CDN URL returned
4. URL stored in MongoDB
5. Files served from CDN (not your server!)

**Benefits:**
- üöÄ Fast delivery (CDN)
- üí∞ Save bandwidth costs
- üîí Secure downloads
- üì¶ Unlimited scalability

---

## üí° Tips

### Development

```bash
# Hot reload (mount code as volume)
# Already configured in docker-compose.yml

# Watch logs
docker-compose logs -f app

# Debug inside container
docker-compose exec app sh
```

### Production

```bash
# Use production MongoDB
# Switch to MongoDB Atlas

# Remove development volumes
# Comment out volume mounts in docker-compose.yml

# Enable only necessary services
# Remove mongo-express in production
```

### Performance

1. **Enable caching:**
   - Redis for session cache
   - CDN for static assets

2. **Optimize images:**
   - Use Cloudinary transformations
   - WebP format

3. **Database:**
   - Add indexes
   - Query optimization
   - Connection pooling (already enabled)

---

## ‚úÖ Deployment Checklist

- [ ] Docker & Docker Compose installed
- [ ] `.env` configured with Cloudinary credentials
- [ ] Mongo DB password changed (production)
- [ ] Services start successfully
- [ ] Database seeded
- [ ] Login works
- [ ] Product images upload to Cloudinary
- [ ] Dashboard shows real stats
- [ ] Products page fetches from API
- [ ] SSL/HTTPS enabled (production)
- [ ] Backups configured
- [ ] Monitoring enabled
- [ ] Logs reviewed

---

## üÜò Support

**Check logs first:**
```bash
docker-compose logs -f
```

**Common commands:**
```bash
# Restart everything
docker-compose restart

# Clean start
docker-compose down && docker-compose up --build -d

# Check service health
docker-compose ps
```

**Resources:**
- Docker docs: https://docs.docker.com
- MongoDB docs: https://docs.mongodb.com
- Next.js docs: https://nextjs.org/docs
- Cloudinary docs: https://cloudinary.com/documentation

---

**üéâ Your Rayan Design platform is now running in Docker!**

Access: http://localhost:3000/ar/login
Login: admin@rayan.com / admin123
